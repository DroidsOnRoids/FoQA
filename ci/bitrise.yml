---
format_version: '4'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android
trigger_map:
- push_branch: master
  workflow: deploy
- pull_request_source_branch: "*"
  workflow: pr
workflows:
  _prepare:
    before_run:
    - xutil_set_java_17
    steps:
    - git-clone: {}
    - cache-pull: {}
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e

            git fetch --tags
        title: Fetch tags
  _publish_results:
    steps:
    - deploy-to-bitrise-io: {}
  deploy:
    steps:
    - gradle-runner:
        inputs:
        - gradle_file: ''
        - gradlew_path: "./gradlew"
        - gradle_options: "--stacktrace --no-daemon --no-parallel --scan"
        - gradle_task: assemble publish
    - cache-push: {}
    before_run:
    - _prepare
  pr:
    steps:
    - gradle-unit-test:
        inputs:
        - unit_test_flags: "--continue --scan"
    - gradle-runner@2:
        title: Lint
        inputs:
        - gradle_task: ":sample:lint"
    - gradle-runner@2:
        title: Detekt
        inputs:
        - gradle_task: detekt
    - gradle-runner@2:
        title: Assemble sample
        inputs:
        - gradle_task: ":sample:assembleRelease"
    - danger:
        inputs:
        - github_api_token: "$DANGER_GITHUB_API_TOKEN"
    before_run:
    - _prepare
    after_run:
    - _publish_results
  xutil_set_java_17:
    steps:
    - script@1:
        title: Sets Java 17 in environment.
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # make pipelines' return status equal the last command to exit with a non-zero status, or zero if all commands exit successfully
            set -o pipefail
            # debug log
            set -x

            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java

            export JAVA_HOME='/usr/lib/jvm/java-17-openjdk-amd64'
            envman add --key JAVA_HOME --value '/usr/lib/jvm/java-17-openjdk-amd64'
app:
  envs:
  - opts:
      is_expand: false
    PROJECT_LOCATION: "."
  - TRAVIS_BRANCH: "$BITRISE_GIT_BRANCH"
  - TRAVIS_PULL_REQUEST: "$PR"
  - TRAVIS_COMMIT_MESSAGE: "$BITRISE_GIT_COMMIT"
  - opts:
      is_expand: false
    GRADLEW_PATH: "./gradlew"
